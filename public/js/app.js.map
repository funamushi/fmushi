{"version":3,"file":"public/js/app.js","sources":["src/client/fmushi.coffee","src/client/models/camera.coffee","src/client/models/circle.coffee","src/client/models/mushi.coffee","src/client/views/app.coffee","src/client/views/circle.coffee","src/client/views/map.coffee","src/client/views/mushi_walking.coffee"],"names":[],"mappings":"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","sourcesContent":["window.Fmushi =\n  Models: {}\n  Collections: {}\n  Views: {}\n  Events: _.extend {}, Backbone.Events\n  screenSize:\n    x: 1000\n    y: 1000\n  debug: false\n  initialize: ->\n    Two.Resolution = 12;\n\n    Fmushi.two = new Two(\n      width:  Fmushi.screenSize.x\n      height: Fmushi.screenSize.y\n      fullscreen: true\n      ).appendTo(document.body)\n\n    Fmushi.stage = new PIXI.Stage 0x000000, true\n\n    renderer = PIXI.autoDetectRenderer Fmushi.screenSize.x, Fmushi.screenSize.y, null, true\n    renderer.view.style.position = \"absolute\"\n    renderer.view.style.top  = \"0\"\n    renderer.view.style.left = \"0\"\n    document.body.appendChild renderer.view\n    Fmushi.renderer = renderer\n\n    animate = ->\n      requestAnimFrame animate\n      Fmushi.Events.trigger 'update'\n      TWEEN.update()\n      Fmushi.two.update()\n      renderer.render Fmushi.stage\n\n    requestAnimFrame animate\n\n    window.Fmushi.app = new Fmushi.Views.App\n\nclass Fmushi.Vector extends Two.Vector\n  toJSON: ->\n    { x: @x, y: @y }\n\nFmushi.vec2 = (x, y) ->\n   new Fmushi.Vector(x, y)\n\n$ ->\n  Fmushi.initialize()\n ","class Fmushi.Models.Camera extends Backbone.Model\n  defaults:\n    x: 0\n    y: 0\n    zoom: 1","class Fmushi.Models.Circle extends Backbone.Model\n  defaults: ->\n    x: 0\n    y: 0\n    r: 400\n\n  initialize: ->\n    @entityCids = {}\n\n  pos: -> \n    new Fmushi.Vector @get('x'), @get('y')\n  \n  entityCount: ->\n    _.size @entityCids\n\n  collisionEntity: (entity) ->\n    collisionPoint = null\n    pos  = @pos()\n    entityPos = { x: entity.get('x'), y: entity.get('y') }\n\n    r  = @get('r')\n    entityR = entity.get('r')\n\n    distance2 = Math.abs pos.distanceToSquared(entityPos)\n\n    # 中にいる場合\n    if @haveEntity entity\n      return if distance2 <= Math.pow(r - entityR, 2)\n      \n      # 外に移動してたらremove\n      if distance2 > Math.pow(r + entityR * 0.7, 2)\n        @removeEntity(entity)\n      else\n        diff = new Fmushi.Vector(pos.x - entityPos.x, pos.y - entityPos.y)\n        collisionPoint = diff.normalize().multiplyScalar(-entityR).addSelf(entityPos)\n\n    # 外にいる場合\n    else\n      return if distance2 >= Math.pow(r + entityR, 2)\n\n      # 中に移動してたらadd\n      if distance2 < Math.pow(r - (entityR * 0.7), 2)\n        @addEntity(entity)\n      else\n        diff = new Fmushi.Vector(pos.x - entityPos.x, pos.y - entityPos.y)\n        collisionPoint = diff.normalize().multiplyScalar(entityR).addSelf(entityPos)\n  \n    if collisionPoint\n      @trigger 'circle:collide', entity, collisionPoint\n\n  addEntity: (entity) ->\n    return if @haveEntity(entity)\n    @entityCids[entity.cid] = true\n    @trigger 'circle:add'\n\n  removeEntity: (entity) ->\n    return unless @haveEntity(entity)\n    delete @entityCids[entity.cid]\n    @trigger 'circle:remove'\n\n  haveEntity: (entity) ->\n    !!@entityCids[entity.cid]\n\nclass Fmushi.Collections.Circles extends Backbone.Collection\n  model: Fmushi.Models.Circle\n  url: '/circles'","class Fmushi.Models.Mushi extends Backbone.Model\n  defaults: ->\n    src: \"/img/funamushi.png\"\n    x: 0\n    y: 0\n    r: 60\n    direction: 'left'\n\n  initialize: ->\n\n  pos: ->\n    new Fmushi.Vector @get('x'), @get('y')\n\nclass Fmushi.Collections.Mushies extends Backbone.Collection\n  model: Fmushi.Models.Mushi\n  url: '/mushies'","class Fmushi.Views.App extends Backbone.View\n  initialize: ->\n    app = @\n\n    @world = world = new PIXI.DisplayObjectContainer\n    Fmushi.stage.addChild world\n\n    @camera = new Fmushi.Models.Camera\n    @locked = false\n    \n    @shapeWorld = shapeWorld = Fmushi.two.makeGroup()\n\n    @initMiniScreen()\n\n    @views = {}\n    @mushies = new Fmushi.Collections.Mushies\n    @circles = new Fmushi.Collections.Circles\n\n    @listenTo @mushies, 'add', (model) ->\n      view = new Fmushi.Views.MushiWalking(model: model)\n      @views[model.cid] = view\n      \n    @listenTo @circles, 'add', (model) -> \n      view = new Fmushi.Views.Circle(model: model)\n      @views[model.cid] = view\n\n    @listenTo @camera, 'change', @onCameraChanged\n    @listenTo Fmushi.Events, 'update', @collisionDetection\n\n    loaderDefer = new $.Deferred\n    loader = new PIXI.AssetLoader ['./app.json']\n    loader.onComplete = -> loaderDefer.resolve()\n    loader.load()\n\n    $.when(\n      loaderDefer.promise(),\n      @circles.fetch(reset: true),\n      @mushies.fetch(reset: true)\n      ).done _.bind(@onAssetLoaded, @)\n\n  initMiniScreen: ->\n    size = { x: 200, y: 200 }\n\n    @miniScreen = miniScreen = new PIXI.DisplayObjectContainer\n    miniScreen.interactive = true\n    miniScreen.position.x = 800\n    miniScreen.position.y = 30\n\n    graphics = new PIXI.Graphics\n    graphics.beginFill(0xFFFF00);\n    graphics.lineStyle(5, 0xFF0000);\n    graphics.drawRect(0, 0, size.x, size.y);\n    graphics.endFill()\n\n    graphics.hitArea = new PIXI.Rectangle(0, 0, size.x, size.y)\n    graphics.interactive = true\n    miniScreen.addChild graphics\n\n    text = new PIXI.Text '地図',\n      font: 'bold 16pt Arial'\n      fill: 'white'\n    text.anchor.x = 0.5\n    text.anchor.y = 0.5\n    text.position.x = size.x / 2\n    text.position.y = -15\n    miniScreen.addChild text\n\n    Fmushi.stage.addChild miniScreen\n\n    pointer = Fmushi.two.makeCircle miniScreen.position.x, miniScreen.position.y, 5\n    pointer.stroke = 'orangered'\n    pointer.fill = '#ff8000'\n    @shapeWorld.add pointer\n\n    app = @\n    camera = @camera\n    graphics.click = graphics.tap = (e) ->\n      return if app.locked\n\n      pointer.translation.set e.global\n\n      pos = e.getLocalPosition(miniScreen)\n      x = (pos.x - (size.x / 2)) * (Fmushi.screenSize.x / size.y)\n      y = (pos.y - (size.y / 2)) * (Fmushi.screenSize.y / size.y)\n      camera.set x: x, y: y\n\n  onCameraChanged: (camera) ->\n    zoom = camera.get 'zoom'\n    zoomWas = camera.changed.zoom || zoom\n    distanceX = camera.get('x') * zoom\n    distanceY = camera.get('y') * zoom\n\n    app = @\n    world = @world\n    shapeWorld = @shapeWorld\n    destX = world.position.x - distanceX\n    destY = world.position.y - distanceY\n\n    @locked = true\n    new TWEEN.Tween(x: world.position.x, y: world.position.y, zoom: zoomWas)\n      .to({ x: destX, y: destY, zoom: zoom }, 500)\n      .easing(TWEEN.Easing.Cubic.InOut)\n      .onUpdate ->\n        world.position.x = @x\n        world.position.y = @y\n        world.scale.x = world.scale.y = @zoom\n        shapeWorld.translation.set @x, @y\n        shapeWorld.scale = @zoom  \n      .onComplete ->\n        world.position.x = destX\n        world.position.y = destY\n        world.scale.x = world.scale.y = zoom\n        shapeWorld.translation.set destX, destY\n        shapeWorld.scale = zoom\n        app.locked = false\n      .start()\n\n  onAssetLoaded: (loaderArgs, circlesArgs, mushiesArgs) ->\n    camera = @camera\n\n    zoomInTexture  = PIXI.Texture.fromFrame('zoom_in.png')\n    zoomIn  = new PIXI.Sprite(zoomInTexture)\n    zoomIn.position.x = -750\n    zoomIn.interactive = true\n    zoomIn.click = zoomIn.tap = (e) ->\n      camera.set 'zoom', (camera.get('zoom') + 0.1)\n    @miniScreen.addChild zoomIn\n\n    zoomOutTexture = PIXI.Texture.fromFrame('zoom_out.png')\n    zoomOut = new PIXI.Sprite(zoomOutTexture)\n    zoomOut.position.x = -700\n    zoomOut.interactive = true\n    zoomOut.click = zoomOut.tap = (e) ->\n      camera.set 'zoom', (camera.get('zoom') - 0.1)\n    @miniScreen.addChild zoomOut\n\n    @circles.add circlesArgs[0]\n    @mushies.add mushiesArgs[0]\n\n  collisionDetection: ->\n    mushies = @mushies\n\n    @circles.each (circle) ->\n      mushies.each (mushi) ->\n        circle.collisionEntity mushi\n      ","class Fmushi.Views.Circle extends Backbone.View\n  initialize: ->\n    attrs = @model.attributes\n    @shape = shape = Fmushi.two.makeCircle attrs.x, attrs.y, attrs.r\n    shape.linewidth = 1\n    shape.noFill()\n    Fmushi.app.shapeWorld.add shape\n\n    for v in @shape.vertices\n      v.was = v.clone()\n\n    @listenTo @model, 'circle:collide', @onCollision\n    @listenTo @model, 'circle:add',     @onAdded\n    @listenTo @model, 'circle:remove',  @onRemoved\n\n    @canCollide = true\n\n  setRandomColor: ->\n    colors = [\n      #F4D6E0'\n      '#DE7699'\n      '#CCE9F9'\n      '#4CBAEB'\n      '#D6E9C9'\n      '#72C575'\n      '#F9F4D6'\n      '#F7D663'\n    ]\n    @shape.stroke = colors[_.random(colors.length - 1)]\n\n  onCollision: (other, collisionPointWorld) ->\n    return unless @canCollide\n\n    r  = @model.get('r')\n    r2 = r * r\n    holdDistanceToSquared = Math.pow(r * 0.2, 2)\n\n    collisionPointLocal = @localPositionAt(collisionPointWorld)\n    vertices = @shape.vertices\n    stretchVertex = _.min(vertices, (v) -> v.distanceToSquared(collisionPointLocal))\n    stretchVertex.copy collisionPointLocal\n   \n  onAdded: (entity) ->\n    @updateLine()\n    @reset()\n\n  onRemoved: (entity) ->\n    @updateLine()\n    @reset()\n\n  updateLine: ->\n    size = @model.entityCount()\n\n    strokeColors = [\n      '#F7D663'\n      '#72C575'\n      '#4CBAEB'\n      '#DE7699'\n    ]\n\n    fillColors = [\n      '#F9F4D6'\n      '#D6E9C9'\n      '#CCE9F9'\n      '#F4D6E0'\n    ]\n\n    if size == 0\n      @shape.linewidth = 1\n      @shape.stroke = 'black'\n      @shape.noFill()\n    else\n      @shape.linewidth = size + 1\n      @shape.stroke = strokeColors[size % strokeColors.length]\n      @shape.fill = fillColors[size % fillColors.length]\n\n  # TODO: 孫要素とかを考慮してない\n  localPositionAt: (worldPos) ->\n    t = @shape.translation\n    new Fmushi.Vector(worldPos.x - t.x, worldPos.y - t.y)\n\n  resetAt: (index) ->\n    v = @shape.vertices[index]\n    return unless v?\n\n    v.tween.stop() if v.tween\n    v.tween = new TWEEN.Tween(x: v.x, y: v.y)\n      .to({ x: v.was.x, y: v.was.y}, 500)\n      .easing(TWEEN.Easing.Bounce.Out)\n      .onUpdate ->\n        v.set @x, @y\n      .onComplete -> \n        v.copy v.was\n        v.tween = null\n      .start()\n\n  reset: ->\n    that = this\n    that.canCollide = false\n    promises = []\n    _.each @shape.vertices, (v) -> \n      unless v.equals(v.was)\n        v.tween.stop() if v.tween\n\n        d = $.Deferred()\n        v.tween = new TWEEN.Tween(x: v.x, y: v.y)\n          .to({ x: v.was.x, y: v.was.y}, 500)\n          .onUpdate ->\n            v.set @x, @y\n          .onComplete ->\n            v.copy v.was\n            d.resolve()\n          .easing(TWEEN.Easing.Bounce.Out)\n          .start()\n        promises.push d.promise()\n\n    $.when.apply($, promises).done ->\n      that.canCollide = true\n    \n","class Fmushi.Views.Map extends Backbone.View\n  ","class Fmushi.Views.MushiWalking extends Backbone.View\n  initialize: -> \n    @listenTo @model, 'change', @onChanged\n\n    if Fmushi.debug\n      @debugShape = Fmushi.two.makeCircle @model.get('x'), @model.get('y'), @model.get('r')\n      @debugShape.stroke = 'orangered'\n      @debugShape.noFill()\n\n    textures = (PIXI.Texture.fromFrame(\"mushi_walk-#{i}.png\") for i in [1..3])\n    @sprite = sprite = new PIXI.MovieClip(textures)\n    sprite.animationSpeed = 0.075\n    sprite.gotoAndPlay 0\n\n    attrs = @model.attributes\n    sprite.anchor.x = 0.4\n    sprite.anchor.y = 0.5\n    sprite.position.x = attrs.x\n    sprite.position.y = attrs.y\n    sprite.scale.x = 0.5\n    sprite.scale.y = 0.5\n\n    sprite.interactive = true\n    sprite.buttonMode = true\n  \n    texture = PIXI.Texture.fromFrame('default.png')\n    text = new PIXI.Sprite texture\n    text.anchor.x = 0.5\n    text.anchor.y = 0.5\n    text.position.x = 0\n    text.position.y = -40\n\n    sprite.addChild text\n\n    model = @model\n\n    # sprite.mousedown = @sprite.touchstart = (e) ->\n    #   e.originalEvent.preventDefault()\n    #   @event = e\n    #   @dragging = true\n    \n    # sprite.mouseup = @sprite.mouseupoutside = @sprite.touchend = (e) ->\n    #   @event = null\n    #   @dragging = false\n    \n    # sprite.mousemove = @sprite.touchmove = (e) ->\n    #   if @dragging\n    #     worldPos = @event.getLocalPosition(Fmushi.stage)\n    #     model.set x: worldPos.x, y: worldPos.y\n\n    @listenTo Fmushi.Events, 'update', ->\n      x = @model.get('x')\n      if @model.get('direction') == 'left'\n        if x < -10\n          @model.set direction: 'right'\n        else\n          @model.set x: x - 1\n      else\n        if x > 1000\n          @model.set direction: 'left'\n        else\n          @model.set x: x + 1\n\n    Fmushi.app.world.addChild sprite\n\n  onChanged: ->\n    if x = @model.changed.x\n      @sprite.position.x = x\n      @debugShape.translation.x = x if @debugShape\n\n    if y = @model.changed.y\n      @sprite.position.y = y\n      @debugShape.translation.y = y if @debugShape\n\n    if d = @model.changed.direction\n      if d == 'left'\n        @sprite.scale.x = 0.5\n      else\n        @sprite.scale.x = -0.5\n\n\n"]}